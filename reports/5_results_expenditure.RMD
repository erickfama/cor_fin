---
title: "Report No. 5"
subtitle: "Public expenditure results"
author:
- "Research assistant: Erick Gabriel Fajardo Martínez"
- "Researcher: Dr. Gabriel Purón Cid"
date: '`r format(Sys.time(), "%d %B %Y")`'
fontsize: 12pt
output: word_document
---

```{r setup, include=FALSE}
Sys.setlocale("LC_TIME", "English")
set.seed(123)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.pos="H")
```

```{r librerias, echo=FALSE}
# Librerias ----
library(tidyverse)
# library(ggtext)
library(here)
options(kableExtra.auto_format = FALSE)
library(kableExtra)
```

```{r lectura, echo=FALSE}
## Egresos ----
eg_inc_predicted <- read_csv(here("./data/3_final/eg_inc_predicted.csv")) %>%
  rename(corrup_hat_eg_inc = corrup_hat, corrup_eg_inc = corrup)

## Modelos ----
model_eg_inc <- readRDS(here("./models/model_eg_inc.rds"))

## Mapa ----
mun_mapa <- sf::read_sf(here("./data/maps/muni.shp"))

# cutoff 
best_cutoff <- function(tipo_fin, method){
  if(tipo_fin == "eg"){
    cutoff <- read_csv("./data/2_interim/eval_eg.csv", locale = locale(encoding = "UTF-8"), show_col_types = FALSE) %>%
      select(method, best_cutoff) 
    if(method == "per"){
      value <- cutoff %>% filter(method == "Percepción") %>% select(best_cutoff) %>% pull() %>% unique() %>% ifelse(is.null(.), 0, .)
    } else {
      value <- cutoff %>% filter(method == "Incidencia") %>% select(best_cutoff) %>% pull() %>% unique() %>% ifelse(is.null(.), 0, .)
    }
  } 
  if(tipo_fin == "ig"){
    cutoff <- read_csv("./data/2_interim/eval_ig.csv", locale = locale(encoding = "latin1"), show_col_types = FALSE) %>%
      select(method, best_cutoff) 
    if(method == "per"){
      value <- cutoff %>% filter(method == "Percepción") %>% select(best_cutoff) %>% pull() %>% unique() %>% ifelse(is.null(.), 0, .)
    } else {
      value <- cutoff %>% filter(method == "Incidencia") %>% select(best_cutoff) %>% pull() %>% unique() %>% ifelse(is.null(.), 0, .)
    }
  }
  value <- ifelse(is.null(value), 0, value)
  return(value)
}
```

# Data 

## ENCIG 2019

The following data was used to train the model. First, ENCIG 2019 survey results were used to classify municipalities into corrupt and not corrupt, the corruption section of the survey captures incidence of corruption within municipalitie by asking for any kind of involvement in a corruption act in the last five years. To determine the classification of corrupt and not corrupt municipalities, first we calculated the proportion of people who reported involvement in an act of corruption, then established a proportion threshold which, according to each municipalitie population proportion, determined if a municipalitie was corrupt or not. This resulted in 172 municipalities classified.

## EFIPEM 2019

The features we used were obtained from the EFIPEM 2019 data set which is an annual report of the public finances of each state and their municipalities. These data contains records of the public expenditure and revenue, and it follows a level structure where the higher level is theme and the lower level is generic heading. We used the generic heading (lowest level) as features for model training, which accounts for 246 total variables. Each of the variables were standardized by the total population of their respective municipalitie.

## Economic Census 2019

We also decided to add another set of variables to give more context to our model, because there are municipalities that are far different than others, i.e. municipalities from southern states as Oaxaca, Chiapas, Tabasco, in comparison with municipalities from northern states like Nuevo León, Baja California, Chihuahua. For that reason data from the economic census 2019 was added. First we selected relevant variables and categorized them by industrial sector according to 2018 North America's Industrial Classification System, which is divided into 20 main economic sectors. 187 is the total number of variables that were added from the economic census. We also added two variables from the Population Census 2020, which are total population of each municipalitie and average scholar level.
The complete data set contains more than 500 variables for the case of public expenditure.

# Model performance

```{r, desempeno, echo=FALSE}
sum_model <- function(model_cm, name){
  cm <- model_cm
  data.frame(Modelo = c(name),
             Sensibilidad = c(round(c(cm$byClass[c("Sensitivity")]), 2)),
             Especificidad = c(round(c(cm$byClass[c("Specificity")]), 2)),
             F1_score = round(c(cm$byClass[c("F1")]), 2),
             Precisión_balanceada = round(c(cm$byClass[c("Balanced Accuracy")]), 2))
}

desemp <- sum_model(model_eg_inc$cm, "Expenditure - Incidence")

kable(desemp, 
      align = "c", 
      caption = "Performance") %>%
  kableExtra::kable_styling(position = "center", latex_options = c("scale_down", "HOLD_position"))
```
