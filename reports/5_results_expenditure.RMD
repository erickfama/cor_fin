---
title: "Report No. 5"
subtitle: "Public expenditure results"
author:
- "Research assistant: Erick Gabriel Fajardo Martínez"
- "Researcher: Dr. Gabriel Purón Cid"
date: '`r format(Sys.time(), "%d %B %Y")`'
fontsize: 12pt
output: word_document
---

```{r setup, include=FALSE}
Sys.setlocale("LC_TIME", "English")
set.seed(123)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.pos="H")
```

```{r librerias, echo=FALSE}
# Librerias ----
library(tidyverse)
library(ggtext)
library(here)
library(caret)
options(kableExtra.auto_format = FALSE)
library(kableExtra)
```

```{r lectura, echo=FALSE}
## Egresos ----
eg_inc_predicted <- read_csv(here("./data/3_final/eg_inc_predicted.csv")) %>%
  rename(corrup_hat_eg_inc = corrup_hat, corrup_eg_inc = corrup)

## Modelos ----
model_eg_inc <- readRDS(here::here("./models/model_eg_inc.rds"))

## Mapa ----
mun_mapa <- sf::read_sf(here("./data/maps/muni.shp"))

# cutoff 
best_cutoff <- function(tipo_fin, method){
  if(tipo_fin == "eg"){
    cutoff <- read_csv("./data/2_interim/eval_eg.csv", locale = locale(encoding = "UTF-8"), show_col_types = FALSE) %>%
      select(method, best_cutoff) 
    if(method == "per"){
      value <- cutoff %>% filter(method == "Percepción") %>% select(best_cutoff) %>% pull() %>% unique() %>% ifelse(is.null(.), 0, .)
    } else {
      value <- cutoff %>% filter(method == "Incidencia") %>% select(best_cutoff) %>% pull() %>% unique() %>% ifelse(is.null(.), 0, .)
    }
  } 
  if(tipo_fin == "ig"){
    cutoff <- read_csv("./data/2_interim/eval_ig.csv", locale = locale(encoding = "latin1"), show_col_types = FALSE) %>%
      select(method, best_cutoff) 
    if(method == "per"){
      value <- cutoff %>% filter(method == "Percepción") %>% select(best_cutoff) %>% pull() %>% unique() %>% ifelse(is.null(.), 0, .)
    } else {
      value <- cutoff %>% filter(method == "Incidencia") %>% select(best_cutoff) %>% pull() %>% unique() %>% ifelse(is.null(.), 0, .)
    }
  }
  value <- ifelse(is.null(value), 0, value)
  return(value)
}
```

# Data 

## ENCIG 2019

The following data was used to train the model. First, ENCIG 2019 survey results were used to classify municipalities into corrupt and not corrupt, the corruption section of the survey captures incidence of corruption within municipalitie by asking for any kind of involvement in a corruption act in the last five years. To determine the classification of corrupt and not corrupt municipalities, first we calculated the proportion of people who reported involvement in an act of corruption, then established a proportion threshold which, according to each municipalitie population proportion, determined if a municipalitie was corrupt or not. This resulted in 233 municipalities classified which are the total number of municipalities that were included in ENCIG's sample.

## EFIPEM 2019

The features we used were obtained from the EFIPEM 2019 data set which is an annual report of the public finances of each state and their municipalities. These data contains records of the public expenditure and revenue, and it follows a level structure where the higher level is budget theme and the lower level is budget item. We used the budget item (lowest level) as features for model training, which accounts for 246 total variables. Each of the variables were standardized by the total population of their respective municipalitie. These data set have records of 2121 municipalities.

## Economic Census 2019

We also decided to add another set of variables to give more context to our model, because there are municipalities that are far different than others, i.e. municipalities from southern states as Oaxaca, Chiapas, Tabasco, in comparison with municipalities from northern states like Nuevo León, Baja California, Chihuahua. For that reason data from the economic census 2019 was added. First we selected relevant variables and categorized them by industrial sector according to 2018 North America's Industrial Classification System, which is divided into 20 main economic sectors. 187 is the total number of variables that were added from the economic census. We also added two variables from the Population Census 2020, which are total population of each municipalitie and average scholar level.
The complete data set contains more than 500 variables for the case of public expenditure.

# Model performance

The following table shows evaluation metrics for the trained model. Overall, model performance is good with an accuracy of 0.78 this performance was improved by adding data from the economic census (in comparison with previous models that we trained and didn't include those variables), and this improvement is better shown in the sensibility of the models which is their hability of correctly classify corrupt municipalities. In that sense, these model has a good predicting power to identify corrupt municipalities, and is reflected on the F1-score which value is 0.86. On the other hand, these model is not very good at detecting not corrupt municipalities according to the specificity value of 0.44, that is the reason for a lower balanced accuracy (0.67). However, in terms of public policy, it is prefer to have a good corrupt detection rate **[insert citation]** to ensure the right focus of regulations programs like audits.

```{r, desempeno, echo=FALSE}
sum_model <- function(model_cm, name){
  cm <- model_cm
  data.frame(Model = c(name),
             Accuracy = c(round(c(cm$overall["Accuracy"]), 2)),
             Sensitivity = c(round(c(cm$byClass[c("Sensitivity")]), 2)),
             Specificity = c(round(c(cm$byClass[c("Specificity")]), 2)),
             F1 = round(c(cm$byClass[c("F1")]), 2),
             `Balanced Accuracy` = round(c(cm$byClass[c("Balanced Accuracy")]), 2),
             row.names = NULL)
}

desemp <- sum_model(model_eg_inc$cm, "Expenditure - Incidence")

kable(desemp, 
      align = "c", 
      caption = "Table. Model Performance") %>%
  kableExtra::kable_styling(position = "center", latex_options = c("scale_down", "HOLD_position"))
```

```{r confusion_matrix, echo=FALSE}
kable(as.matrix(model_eg_inc$cm), 
      align = "c",
      caption = "Table. Confusion Matrix") %>%
  kableExtra::kable_styling(position = "center", latex_options = c("scale_down", "HOLD_position"))
```


## Results

Gradient boosting (as others Tree based algorithms) has the feature of variable importance which is a score that indicates the relative contribution of each feature in predicting the outcome (Friedman et al., 2009). This score goes from 100 to 0, were 100 indicates the most important variable and 0 the less important variable. Table.x list the 20 most important variables.

```{r eg_inc_vars, echo=FALSE}
eg_inc_dicc <- read_csv(here::here("./data/3_final/eg_inc_dicc.csv"), locale = locale(encoding = "latin1"))

eg_inc_varimp <- model_eg_inc$var_imp$importance %>%
  add_rownames(var = "Variables") %>%
  rename("Importance" = "Overall") %>%
  filter(str_detect(Variables, "^partida_generica|^subpartida"))

# Loop para reemplazar los codigos de las variables con la descripcion del diccionario
for(i in seq(1, nrow(eg_inc_varimp))){
  if(eg_inc_varimp$Variables[i] %in% eg_inc_dicc$variables & !str_detect(eg_inc_varimp$Variables[i], "^partida_generica|^subpartida")){
    name_index <- which(eg_inc_dicc$variables %in% eg_inc_varimp$Variables[i])
    eg_inc_varimp$Variables[i] <- eg_inc_dicc$descripcion[name_index]
  } else {
    eg_inc_varimp$Variables[i] <- str_to_sentence(str_replace_all(eg_inc_varimp$Variables[i], "_", " "))
  }
}

kable(eg_inc_varimp %>% slice_head(n = 20), 
      align = "c",
      caption = "Variable importance. Expenditure") %>%
  kableExtra::kable_styling(position = "center", latex_options = c("scale_down", "HOLD_position"))
```

As we can see, the most important variables that characterize corrupt municipalities correspond to financial assets related to payroll, financial services, and subsidies; Construction items are also relevant, which is not surprising according to the literature [**insert citation**], especially in articles related to the creation of infrastructure or the acquisition of materials.

A main application of these contribution is the classification of municipalities that do not have any type of corruption measurement because they were not part of ENCIG's sample, and that is the case for the rest of 1888 municipalities. The model serves as a tool to classify the rest of municipalities based on only in their budget items. The following maps illustrates the difference between the classification maded with ENCIG's data (fig. 1) and model classification (fig. 2).

```{r map, echo=FALSE, fig.align='center', out.width="90%"}
## Predicted

## Egresos ----

eg_inc_predicted <- read_csv(here("./data/3_final/eg_inc_predicted.csv")) %>%
  rename(corrup_hat_eg_inc = corrup_hat, corrup_eg_inc = corrup)

## Ingresos ----

ig_inc_predicted <- read_csv(here("./data/3_final/ig_inc_predicted.csv")) %>%
  rename(corrup_hat_ig_inc = corrup_hat, corrup_ig_inc = corrup)

## Mapa ----
mun_mapa <- sf::read_sf(here("./data/maps/muni.shp"))

### Merge ----
mun_mapa <- mun_mapa %>%
  rename(mun_inegi = CVEGEO) %>%
  left_join(eg_inc_predicted, by = "mun_inegi") %>%
  left_join(ig_inc_predicted, by = "mun_inegi") %>%
  select(mun_inegi:geometry, starts_with("corrup")) %>%
  mutate(across(starts_with("corrup"), ~ ifelse(.x == "corrupto", 1, 0)),
         across(starts_with("corrup"), ~ factor(.x, levels = c(1, 0), labels = c("corrupto", "no_corrupto"))))

### Incidencia ----

#### Etiquetas reales ----
mun_mapa %>%
  ggplot(aes(fill = corrup_eg_inc)) +
  geom_sf() +
  scale_fill_discrete(name = "", labels = c("Corrupt", "Not corrupt", "Not in ENCIG's sample"), type = c("#cc6f29", "#2986cc")) +
  labs(title = "Figure 1. Actual classification of municipalities",
       subtitle = glue::glue("ENCIG municipalitie sample: {sum(!is.na(eg_inc_predicted$corrup_eg_inc))}"),
       caption = "Note: Own elaboration based on ENCIG 2019 data.") +
  theme_bw() +
  theme(text = element_text(size = 10))

#### Etiquetas predichas ----
mun_mapa %>%
  ggplot(aes(fill = factor(corrup_hat_eg_inc, levels = c("corrupto", "no_corrupto")))) +
  geom_sf() +
  scale_fill_discrete(name = "", labels = c("Corrupt", "Not corrupt", "No budget data"), type = c("#cc6f29", "#2986cc")) +
  theme_bw() +
  labs(title = "Figure 2. Predicted classification",
       subtitle = glue::glue("2121 municipalities classified"),
       caption = "Note: Own elaboration based on EFIPEM 2019 data.") +
  theme_bw() +
  theme(text = element_text(size = 10))
```

# References 

Friedman, J., Hastie, T. & Tibshirani, R. (2009). *The elements of statistical learning: Data mining, inference and prediction* (2nd ed.). Springer.